#!/usr/bin/env bash

FSHTANK=${1-.}

function replace_ping_with_curl {
  (
    cd $FSHTANK && \
      perl -pi -e 'BEGIN {undef $/} s/^case "\$OSTYPE" in.*esac/curl -sSf tx.fhir.org > \/dev\/null/gms' _updatePublisher.sh
  )
}

function run_ig_publisher {
  if [[ ! -f "$FSHTANK/input-cache/publisher.jar" ]]; then
    echo "* Installing publisher (force)"
    ( cd $FSHTANK && chmod 0755 *.sh && ./_updatePublisher.sh -f )
    replace_ping_with_curl
  fi

  if [ $? -ne 0 ] ; then
    echo "!!! Error updating publisher"
    exit 1
  fi

  echo "* Running IG Publisher"
  ( cd $FSHTANK && chmod 0755 *.sh && JAVA_OPTS=$JAVA_OPTS ./_genonce.sh )

  if [ $? -ne 0 ] ; then
    echo "!!! Error running publisher"
    exit 1
  fi

  if [ $? -ne 0 ] ; then
    echo "!!! Error copying"
    exit 1
  fi
}

echo "* Fix _updatePublisher.sh"
replace_ping_with_curl

echo "* Building Implementation Guide"
run_ig_publisher
